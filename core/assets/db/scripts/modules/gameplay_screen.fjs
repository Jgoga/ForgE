game.provider("$GameplayScreen", function($log, $input, $entities, $assets, $gdxApp, $time) {
  var TAG                    = "$GameplayScreen";
  var FAR_CAMERA             = 100;
  var NEAR_CAMERA            = 0.01;
  var FIELD_OF_VIEW          = 70;
  function GameplayController(teleport, level) {
    $log.info(TAG, "Initialazing screen...");
    this.teleport      = teleport;
    this.level         = level;
    $input.setCursorCatched(true);

    this.cameraController          = new FirstPersonCameraController(level.camera);
    this.level.camera.far          = FAR_CAMERA;
    this.level.camera.near         = NEAR_CAMERA;
    this.level.camera.fieldOfView  = FIELD_OF_VIEW;

    this.spawnPlayer();
  }

  GameplayController.prototype.spawnPlayer = function() {
    var playerEntity       = $entities.get("player").build(this.level.entities);
    playerEntity.getComponent(PlayerComponent).camera = this.level.camera;
    this.level.terrainMap.localVoxelPositionToWorldPosition(this.teleport.voxelPosition, playerEntity.getComponent(PositionComponent).vector);
    playerEntity.getComponent(PositionComponent).vector.sub(-0.5);
    this.level.entities.addEntity(playerEntity);
  }

  GameplayController.prototype.spawnEntity = function(entityName) {
    var playerEntity            = $entities.get(entityName).build(this.level.entities);
    var playerPositionComponent = playerEntity.getComponent(PositionComponent);
    var temp                    = new Vector3(this.level.camera.direction).scl(2);
    temp.add(this.level.camera.position);

    playerEntity.getComponent(PositionComponent).vector.set(temp);
    temp.set(this.level.camera.direction).scl(15);
    playerEntity.getComponent(RigidBodyComoponent).initialImpulse.set(temp);
    this.level.entities.addEntity(playerEntity);
  }

  GameplayController.prototype.render = function(delta) {
    $time.update();
    $assets.update();
    this.cameraController.update(delta);
    this.level.render(delta);

    if ($input.isKeyJustPressed(Input.Keys.E)) {
      this.spawnEntity("crate");
    }

    if ($input.isKeyPressed(Input.Keys.ESCAPE)) {
      $gdxApp.exit();
    }
  }

  GameplayController.prototype.dispose = function() {
    this.level = null;
    this.teleport = null;
  }

  return {
    create: function(teleport, level) {
      return new AbstractScreen({
        initialize: function() {
          this.controller = new GameplayController(teleport, level);
        },

        render: function (delta) {
          this.controller.render(delta);
        },

        dispose: function() {
          this.controller.dispose();
        }
      });
    }
  };
});
